<% 
function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
    var R = 6371; // Radius of the earth in km
    var dLat = deg2rad(lat2-lat1);  // deg2rad below
    var dLon = deg2rad(lon2-lon1); 
    var a =  Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2); 
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    var d = R * c; // Distance in km
    return d;
}

function deg2rad(deg) {
    return deg * (Math.PI/180)
}

let citiesToPharmacies = new Map();
cities.forEach(city => citiesToPharmacies.set(city, [])); // init map with wmpty lists
selectedPharmacyIds.forEach(id => {
    let pharmacy = pharmacies.find(p => p.id == id);
    let locality = localities.find(l => l.uuid == pharmacy.localityUuid);
    let city = cities.find(c => c.uuid == locality.cityUuid);
    citiesToPharmacies.get(city).push(pharmacy);
});

let myLat = 35.13, myLng = 33.36;// todo

cities.sort(function(c1, c2) {
    d1 = getDistanceFromLatLonInKm(c1.lat, c1.lng, myLat, myLng);
    d2 = getDistanceFromLatLonInKm(c2.lat, c2.lng, myLat, myLng);
    return d1 - d2;
});
cities.forEach(city => {
    console.log(`city: ${city.nameEl} contains ${citiesToPharmacies.get(city).length} pharmacies`);
%>

<div>
    <div class="alert alert-success">
        <%= city.nameEl %>
    </div>
<%
    citiesToPharmacies.get(city).forEach(pharmacy => {
        let locality = localities.find(l => l.uuid == pharmacy.localityUuid);
%> 
    <div class="my-3 p-3 bg-white rounded box-shadow">
        <strong class="h5 border-bottom border-gray pb-2 mb-0"> <a href="/pharmacy/<%= pharmacy.id %>"> <%= pharmacy.name %> <i class="fa-solid fa-arrow-up-right-from-square"></i> </a> </strong>
        <%= pharmacy.address %>, CY-<%= pharmacy.addressPostalCode %>, <%= locality.nameEl %>
        <%= pharmacy.addressDetails ? `(${pharmacy.addressDetails})` : `` %>
        <div class="media text-muted pt-3">
        <p class="media-body pb-3 mb-0 lh-125">
            <a href="https://www.google.com/maps/search/?api=1&query=<%= pharmacy.lat %>,<%= pharmacy.lng %>" target="_blank" class="btn btn-success btn-sm"> <i class="fa-solid fa-map"></i> View on map <i class="fa-solid fa-arrow-up-right-from-square"></i></a>
            <a href="tel:<%= pharmacy.phoneBusiness %>" title="Dial phone number" class="btn btn-success btn-sm"> <i class="fa-solid fa-phone"></i> Call <%= pharmacy.phoneBusiness %> </a>
        </p>
        </div>
    </div>
<% 
    });

%>
</div>
<%
});
%> 
